---
title: "【論文解説】Taobaoの候補商品検索: MNR - 検索などの「捨てていたランキング結果」を再利用して取引量を5%向上" # zenn: 記事のタイトル
emoji: "♻️" # zenn: アイキャッチとして使われる絵文字（1文字だけ）
type: "idea" # zenn: tech: 技術記事 / idea: アイデア記事
topics: ["] # zenn: タグ。["markdown", "rust", "aws"]のように指定する
published: false # zenn: 公開設定（falseにすると下書き）
論文URL: https://arxiv.org/abs/2408.00247 # paper: URL
主な著者: Yingcai Ma, Ziyang Wang, Yuliang Yan, et al.  # paper: 主な著者
主な所属機関: Taobao, Alibaba Group # paper: 主な所属機関
論文公開日付: 2024-08-06 # paper: 論文公開日付
tags: ["recommendation", "retrieval", "candidate generation", "alibaba"] # paper: tags
---



**記事の3行まとめ**

* Taobaoが提案する新フレームワークMNRは、モデルの追加学習なしで推薦精度を大幅改善
* 検索などの他シナリオで計算済みだが表示されなかった高品質なランキング結果を準リアルタイムで再利用
* 世界最大級のECサイトで取引量（GMV）5%増を達成し、シンプルながら強力な効果を実証

## 1. はじめに

今回は、2024年8月にアリババグループ（Taobao）から発表された、推薦システムの候補生成（Matching）フェーズに関する論文 [Simple but Efficient: A Multi-Scenario Nearline Retrieval Framework for Recommendation on Taobao](https://arxiv.org/abs/2408.00247) を紹介します。

大規模な推薦システムにおいて、精度向上と計算コストは常にトレードオフの関係にあります。特に候補生成フェーズでは、レイテンシ制約から軽量なモデルを使わざるを得ず、複雑なユーザー心理を捉えきれないという課題がありました。

本論文が提案するのは、**新たなモデルを一切追加学習することなく**、システムアーキテクチャの工夫だけでこの壁を突破する方法です。具体的には、検索や詳細ページといった他シナリオで計算されたものの、画面枠の都合で表示されなかった高品質なランキング結果を、ストリーミング処理によって準リアルタイムに回収・再利用するというアプローチです。

このフレームワークを世界最大級のECサイトであるTaobaoのトップページに実装した結果、**取引量（Transaction Volume）を5%向上させる**、驚異的なビジネスインパクトを達成しました。論文タイトルのSimple but Efficientの通り、単純ですが非常に効果的な手法を解説します。

## 2. 本論文の注目ポイント

この論文が評価されるべき理由は、単に成果が出たからだけではありません。その手法がスマートで、示唆に富んでいるからです。

### 1. 学習コストゼロで性能向上を実現

通常、推薦システムの精度を上げるには、より大きく複雑なモデルを学習させたり、推論サーバーを増強したりします。しかし本手法は、モデルを強化するのではなく、未活用の計算資産を活用するというアプローチを採用しました。既存のランキングログを再利用するため、追加のモデル学習や重い推論コストをかけずに、高度なパーソナライズを実現しています。

### 2. 他シナリオの未露出データを救出・活用

図1に示すように、検索やカートなど、ユーザーの明確な意図が反映されるシナリオでは、裏側で数千件の商品がスコアリングされています。しかし、スマホの画面に表示されるのはそのごく一部です。  
本論文は、ランキング上位でありながら画面枠の都合で表示されなかった商品に着目しました。これらを現在のシナリオ（トップページ）の候補として準リアルタイムに転用することで、軽量な候補生成フェーズでありながら、重厚なランキングフェーズと同等の精度を持つ候補生成を可能にしました。

![figure1](../images/論文解説%20Simple%20but%20Efficient:%20A%20Multi-Scenario%20Nearline%20Retrieval%20Framework%20for%20Recommendation%20on%20Taobao/figure1.png)

### 3. 大規模商用環境での圧倒的な実証成果

アカデミックな実験環境だけでなく、世界最大級のECサイト（Taobao）のトップページにおいて、**取引量（Transaction Volume）5%増**という巨大なビジネスインパクトを証明した点は重要です。オフライン評価だけでなく、実際のA/Bテストで明確な成果を出しており、実務における再現性と信頼性が高い手法と言えます。

## 3. なぜこの論文を選んだか

私がこの論文に注目したのは、実務における推薦システムの課題感と、本論文のアプローチが合致していたためです。具体的には以下の3点です。

1. 直近のニーズを捉える問題設定:  
   ECサイトのトップページのように、ユーザーが訪れるたびに変化する直近の興味・関心を即座に反映して商品を推薦するという問題設定に関心がありました。  
2. 既存モデル（Two-Tower）の限界:  
   一般的に使われるTwo-Towerモデル等は、軽量である反面、ユーザーの複雑な心理や多様な興味を1つのベクトルに圧縮して表現するため、表現力や精度に限界があると感じていました。  
3. モデルレスな解決策:  
   複雑なモデルを新しく作るのではなく、他シナリオで既に計算済みの、高度にパーソナライズされたランキング結果を再利用するという解決策に惹かれました。計算資源の無駄をなくし、結果として売上（GMV）を大きく向上させたアプローチは非常に合理的です。

## 4. 論文解説

### 4.1. 概要 (Abstract)

本論文は、アリババグループ（Taobao）が提案する、大規模推薦システムにおける新しい候補生成（Matching/Retrieval）フレームワークMNR (Multi-Scenario Nearline Retrieval)を提案するものです。

推薦システムの候補生成フェーズは、数億規模のアイテムからユーザーに関連する数千件を高速に絞り込む必要があるため、一般的に軽量なモデル（協調フィルタリングやTwo-Towerモデルなど）が採用されます。しかし、軽量化の代償として、複雑なユーザーの興味や行動文脈を十分に捉えきれないという課題がありました。

一方で、最終的な表示順を決めるランキングフェーズでは、計算コストの高い高精度なモデルが使われています。しかし、スマホの画面サイズには限りがあるため、せっかくランキングフェーズで高スコアと判定されても、上位数件以外はユーザーの目に触れることなく捨てられていました。

そこで著者は、他シナリオ（検索や詳細ページなど）のランキングフェーズで計算された高品質なスコア情報を、準リアルタイムで現在のシナリオの候補生成フェーズに転用するというアプローチを提案しました。このMNRフレームワークをTaobaoのホームページ（"Guess You Like"）に実装した結果、モデル学習なしで商品取引量を5%向上させるという成果を達成しました。

### 4.2. 既存研究とこの論文の位置づけ (Introduction / Related Work)

推薦システムの研究において、この論文は以下の2つの文脈に対する第3の解として位置づけられます。

#### 候補生成手法の限界と進化

従来の候補生成フェーズの主流である協調フィルタリングやDeep Learningベースの手法は、計算効率と表現力のトレードオフがありました。Netflixなども準リアルタイム処理を提案していましたが、リアルタイム性やリソースコストに課題がありました。

これに対し、本論文のMNRは、新たなモデルを一から構築するのではなく、**既存のランキング結果を再利用する**というアプローチを採りました。これにより、追加の計算コストをほとんどかけずに、Deep Learningモデル並み、あるいはそれ以上の表現力を候補生成フェーズに持ち込んでいます。

#### マルチシナリオ・モデリングの課題

また、複数のシナリオ（トップページ、検索、カートなど）のデータを統合学習する従来モデルは、構造が複雑で巨大になりがちでした。そのため、推論コストが高く、数億件を扱う候補生成フェーズでの利用は現実的ではありませんでした。

MNRはモデルの統合ではなく結果の統合というシンプルなアプローチを取ることで、システムを複雑化させずにマルチシナリオ情報の活用を実現しました。

### 4.3. 提案手法 (Methodology)

MNRの核心は、他シナリオで捨てられていたランキング結果を、ストリーム処理で回収し、現在のシナリオの候補として復活させる点にあります。

#### 手法のコンセプト

ユーザーはECサイト内において、「検索する」「商品詳細を見る」「カートに入れる」など、様々なシナリオを回遊します。各シナリオのランキングフェーズでは、数百〜数千のアイテムに対して高精度なスコアリングが行われますが、実際に画面に表示されるのは上位数件だけです。

MNRは、この**表示されなかったがスコアは高かったアイテム**に着目しました。これらはユーザーの興味を強く反映しているはずだからです。

#### システムアーキテクチャ

MNRの実装フローは以下の通りです（論文 Figure 2参照）。

![figure2](../images/論文解説%20Simple%20but%20Efficient:%20A%20Multi-Scenario%20Nearline%20Retrieval%20Framework%20for%20Recommendation%20on%20Taobao/figure2.png)

1. ランキング結果の取得:  
   ユーザーが任意のシナリオ $s$（例：検索結果）を訪れた時刻 $t$ において、ランキングモデルが出力したアイテムリストを $R_s^t = (e_1^t, e_2^t, ..., e_n^t)$ とします。ここで $n$ は数千のオーダーです。  
2. 切り捨て（Truncation）による選抜:  
   すべての結果を保存・転送するのはコストが高いため、上位のアイテムのみを残して切り捨て処理（Truncate）を行います。これにより、よりコンパクトなリスト $\mathcal{R}_s^t$ を生成します。

$$
\mathcal{R}_s^t = Truncate_s(R_s^t)
$$

3. ユーザーキューの維持:  
   ユーザーごとの過去のランキング結果を保持するため、シナリオ $s$ ごとにキュー$C_s$ を利用します。ここではFIFO戦略を採用し、最新の興味を維持します。

$$
C_s = Queue(\mathcal{R}_s^{t1}, \mathcal{R}_s^{t2}, ..., \mathcal{R}_s^{tl})
$$

4. 候補生成:  
   Apache Flinkを用いたストリーム処理基盤がこれらのログを準リアルタイムで処理し、後述するスコアリング関数に基づいて $C_s$ からさらに Top-K のアイテムを選定（$E_c$）し、オンラインDBに格納します。ターゲットシナリオ（トップページ）のリクエスト時には、ここから即座に候補を取得します。

#### Streaming Candidate Scoring（スコアリング関数）

集められた他シナリオの候補アイテムを、トップページの候補として採用すべきかどう判断するかについて、著者は以下の2つの要素を考慮したシンプルなスコアリング関数を定義しました。

1. **Original Ranking Score (Relevance):** 元のシナリオで何位だったか。上位であるほど質が高い。  
2. **Access Time (Recency):** そのシナリオをいつ訪れたか。直近の行動ほど現在の興味に近い。

具体的な数式は以下の通りです。

$$
\text{finalScore} = \left( \frac{\alpha}{\alpha + \text{rank\_index}} \right) \times \left( \frac{\beta}{\beta + \text{time\_index}} \right)
$$

ここで、$\text{rank\_index}$ は元のシナリオでのランキング順位（0始まり）、$\text{time\_index}$ はユーザーの訪問順序（最新が0）を表します。また、$\alpha, \beta$はハイパーパラメータです。
この関数により、例えば「昨日の検索で1位だった商品」と「今の詳細ページで5位だった商品」のどちらを優先すべきかを、統一的なスコアで比較可能にしています。

### 4.4. 実験と結果 (Experiments)

Taobaoの実際のトラフィックを用いた実験により、MNRの有効性が証明されました。実験では、Taobaoホームページを対象とし、メイン検索、画像検索、購入後ページ、詳細ページなどの情報を活用しました。

#### 実験設定と評価指標

本論文では、提案手法の有効性を測るために以下の3つの指標を採用しています。

1. CTCVR (Click-Through & Conversion Rate):  
   アイテムが露出してから取引に至る確率。ビジネスゴール（GMV）に直結する最重要指標です。  
2. Hitrate:  
   ユーザーが全シナリオで行った実際の行動（クリック等）を、推薦候補がどれだけカバーできていたかを示す正解率。MNRがユーザーの興味を正しく捉えているかを表します。  
3. PVR (Page View Ratio):  
   最終的にユーザーに表示されたアイテム全体のうち、MNR経由で候補に挙がったアイテムが占める割合。MNRが提案した候補が、後段のランキングモデルによって「質が高い」と評価され、生き残った割合を示します。

#### 主な結果 (Offline Evaluation)

オフライン評価において、MNRは多くのシナリオでベースラインを上回る性能を示しましたが、**シナリオの特性によっては性能が低下するケース**も確認されました。

まず、**劇的な性能向上**が見られたのは、メイン検索、詳細ページ、画像検索といったシナリオです。特にメイン検索を活用した場合、ベースライン比で**CTCVRが+57.0%**改善しました。ユーザーの検索意図は非常に強いため、これをトップページに持ち込む効果が大きいことを示しています。

一方で、性能が低下するケースも確認されました。店舗内ページでは、逆にCTCVRが-33.0%と大幅に悪化しました。  
この理由は、店舗内ページはそもそも商品数が少なく、ランキング上位のほとんどが既にユーザーに表示されてしまっているためです。その結果、MNRが回収できたのは表示されなかった下位アイテムばかりとなり、質の低い候補を推薦することになってしまいました。この結果は、MNRが十分な候補数があり、かつ表示枠が限られている（未露出の良質アイテムが眠っている）シナリオで有効であることを示唆しています。

![table1](../images/論文解説%20Simple%20but%20Efficient:%20A%20Multi-Scenario%20Nearline%20Retrieval%20Framework%20for%20Recommendation%20on%20Taobao/table1.png)

#### オンラインA/Bテスト (Online Performance)

実際のユーザーに対する1ヶ月間のA/Bテストでは、**取引量が+5%向上**しました。超大規模サービスであるTaobaoにおいて、GMVに直結する指標が5%向上するのは極めて大きなインパクトです。

#### Ablation Study（要因分析）

MNRの構成要素の重要性についても検証が行われています。

まず、Flinkを用いたオンライン処理を日次バッチのオフライン処理に切り替えたところ、性能が**36%低下**しました。ユーザーの興味は刻一刻と変わるため、鮮度が重要であることが分かります。

![table2](../images/論文解説%20Simple%20but%20Efficient:%20A%20Multi-Scenario%20Nearline%20Retrieval%20Framework%20for%20Recommendation%20on%20Taobao/table2.png)

次に、提案したスコアリング関数（数式）を使わず、単純な**新しい順（FIFO）だけで候補を選んだ場合、性能は8.9%低下**しました。これはただ新しければ良いわけではなく、元のシナリオで高く評価されていた（質の高い）アイテムを選ぶロジックが必要であることを裏付けています。

![table3](../images/論文解説%20Simple%20but%20Efficient:%20A%20Multi-Scenario%20Nearline%20Retrieval%20Framework%20for%20Recommendation%20on%20Taobao/table3.png)

最後に、ランキング順位重視のパラメータ$\alpha$を極端に大きくし、時間の鮮度を軽視した設定にしたところ、CTCVRは**15.0%低下**しました。これは過去にどれだけ高評価だったかよりも今興味があるかのバランスを取ることが不可欠であることを示しています。

![table4](../images/論文解説%20Simple%20but%20Efficient:%20A%20Multi-Scenario%20Nearline%20Retrieval%20Framework%20for%20Recommendation%20on%20Taobao/table4.png)

### 4.5. 結論 (Conclusion)

本論文は、マルチシナリオのランキング結果を活用した準リアルタイムな候補生成フレームワークMNRを提案しました。  
MNRは、複雑なモデル学習を一切行わず、システムアーキテクチャの工夫（ストリーム処理とシンプルなスコアリング）のみによって、Taobaoホームページの取引量を5%向上させることに成功しました。  
この成果は、推薦システムにおいてモデルの複雑化だけが正解ではなく、既存データの有効活用とデータの鮮度が重要であることを示しています。

## 5. 記事著者の考察と実務への応用

本論文の結果を受けて、実務に適用する際に考慮すべき点や、隠れたコストについて考察します。

### 他シナリオの転用について

この論文のアプローチで特に興味深い点は、その「シンプルさ」と「筋の良さ」です。
通常、推薦システムの精度向上を目指す場合、モデル構造の複雑化や新規特徴量の追加といった方向に進みがちです。しかし本手法は、「すでに計算コストを払って算出したにも関わらず、利用されずに破棄されているデータ（他シナリオのランキング結果）」に着目しました。
これは技術的なブレイクスルーというよりも、高度な発想の転換による成果だと言えます。
実装の観点でも、新たに巨大なモデルの学習パイプラインを構築・運用するコストに比べれば、ログのストリーム処理とフィルタリングの実装コストは低く抑えられます。既存資産を有効活用し、最小限の工数で確実な成果（GMV増）を生み出すこのアプローチは、非常に合理的な解決策です。

エンジニアとして、このように最小の工数で本質的な価値を生み出す視点は、常に持ち続けていたいと感じさせられました。

### コールドスタート問題への対処

MNRはユーザーの直近の行動ログ（ランキングログ）に基づく手法であるため、行動履歴のない完全な新規ユーザー（コールドスタート）には機能しません。ログが存在しないため、再利用するスコア自体がないからです。  
実務においては、MNR一本に候補生成を頼るのではなく、新規ユーザーに対しては従来の人気ランキングやユーザー属性（性別・年代）ベースの推薦を併用するハイブリッドな構成が必須となります。MNRはあくまで、ある程度行動履歴が溜まった既存ユーザーに対するブースト機能として位置づけるのが適切です。

### 潜在ニーズへの対応（セレンディピティの欠如）

この手法の最大の弱点は、ユーザーがサイト上で発露したニーズに特化しすぎている点にあります。  
MNRが推薦するのは、あくまで過去に検索結果や詳細ページなどでランク付けされたが、表示されなかった商品です。つまり、ユーザーの意識の範疇にある商品が中心となります。  
一方で、ユーザー自身はまだ認知していないが、類似した嗜好を持つ他者がよく購入している商品のような、潜在的なニーズや意外性のある商品（セレンディピティ）を推薦することは苦手です。  
したがって、MNRですべての候補生成を置き換えるのではなく、User-to-Userの協調フィルタリングなど、視野を広げるための探索的なモデルと組み合わせることが、長期的なユーザーエンゲージメントには不可欠です。

## 6. まとめ

本論文が示した成果と実務への示唆は、以下の2点に集約されます。

* 埋もれたデータを見直すことの重要性:  
  多くのサービスにおいて、検索結果や商品詳細ページで計算されたスコアは、画面に表示されなかった時点で破棄されています。本手法は、これら計算済みの未利用データこそが、ユーザーの直近の興味を最も正確に反映した宝の山であることを示唆しています。エンジニアやPMは、新しいモデルを導入する前に、足元のログ基盤に眠っている資産がないかを見直すべきです。  
* 銀の弾丸ではなく、適材適所のハイブリッド運用が鍵:  
  MNRは強力ですが、万能ではありません。行動履歴のない新規ユーザー（コールドスタート問題）や、意外性のある商品との出会い（セレンディピティ）には対応できません。実務においては、MNRを直近の興味を刈り取るブースト装置として位置づけ、長期的な興味を捉える既存モデルや、探索的な協調フィルタリングと組み合わせるハイブリッドな構成が求められます。

## 7. 参考文献・次に読むべき論文

* 本論文: [Simple but Efficient: A Multi-Scenario Nearline Retrieval Framework for Recommendation on Taobao](https://arxiv.org/abs/2408.00247)  
* 比較手法: MIND ([Multi-Interest Network with Dynamic Routing](https://arxiv.org/abs/1904.08030))  
